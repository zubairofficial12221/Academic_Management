<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard — EduTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="../assets/css/main.css" rel="stylesheet">
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">EduTrack</div>
    <nav class="sidebar-nav">
      <a class="nav-link active" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Dashboard</a>
      <a class="nav-link" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a>
      <a class="nav-link" href="seat-arrangement.html"><i class="bi bi-grid-3x3"></i> Seat Arrangement</a>
      <a class="nav-link" href="results.html"><i class="bi bi-journal-text"></i> Results</a>
      <a class="nav-link" href="weather.html"><i class="bi bi-cloud-sun"></i> Weather Monitor</a>
      <a class="nav-link" href="notifications.html"><i class="bi bi-bell"></i> Notifications <span class="badge bg-danger ms-1" id="unreadBadge" style="display:none;">0</span></a>
      <a class="nav-link" href="dashboard.html"><i class="bi bi-search"></i> Search Students</a>
      <a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</a>
    </nav>
  </aside>
  <div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3 mb-0">Dashboard</h1>
      <button type="button" class="btn btn-edu d-lg-none" id="menuToggle"><i class="bi bi-list"></i></button>
    </div>
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card card-glass stat-card p-3 animate-fade-in-up" style="animation-delay: 0.1s">
          <div class="stat-value" id="statTotalStudents">0</div>
          <div class="stat-label">Total Students</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card card-glass stat-card p-3 animate-fade-in-up" style="animation-delay: 0.15s">
          <div class="stat-value text-success" id="statPresent">0</div>
          <div class="stat-label">Present Today</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card card-glass stat-card p-3 animate-fade-in-up" style="animation-delay: 0.2s">
          <div class="stat-value text-danger" id="statAbsent">0</div>
          <div class="stat-label">Absent Today</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card card-glass stat-card p-3 animate-fade-in-up" style="animation-delay: 0.25s">
          <div class="stat-value" id="statNotifications">0</div>
          <div class="stat-label">Notifications Sent</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card card-glass stat-card p-3 animate-fade-in-up" style="animation-delay: 0.3s">
          <div class="stat-value" id="statExams">0</div>
          <div class="stat-label">Exams Scheduled</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card card-glass stat-card p-3 animate-fade-in-up" style="animation-delay: 0.35s">
          <div class="stat-value" id="statResults">0</div>
          <div class="stat-label">Results Uploaded</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card card-glass stat-card p-3 animate-fade-in-up" style="animation-delay: 0.4s">
          <div class="stat-value text-info" id="statAvgAttendance">0%</div>
          <div class="stat-label">Avg Attendance %</div>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card card-glass stat-card p-3 animate-fade-in-up" style="animation-delay: 0.45s">
          <div class="stat-value" id="statWeather">—</div>
          <div class="stat-label">Weather Status</div>
        </div>
      </div>
    </div>
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card card-glass p-3 mb-4">
          <h5 class="mb-3">7-Day Attendance Trend</h5>
          <canvas id="chartTrend" height="200"></canvas>
        </div>
        <div class="card card-glass p-3">
          <h5 class="mb-3">Department-wise Attendance</h5>
          <canvas id="chartDept" height="200"></canvas>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card card-glass p-3 mb-4">
          <h5 class="mb-3">Quick Actions</h5>
          <div class="d-grid gap-2">
            <a href="attendance.html" class="btn btn-edu">Mark Attendance</a>
            <a href="seat-arrangement.html" class="btn btn-outline-edu">Generate Seats</a>
            <a href="results.html" class="btn btn-outline-edu">Upload Results</a>
            <a href="weather.html" class="btn btn-outline-edu">Check Weather</a>
          </div>
        </div>
        <div class="card card-glass p-3">
          <h5 class="mb-3">Recent Activity</h5>
          <div id="recentActivity" class="small text-muted">Loading…</div>
        </div>
      </div>
    </div>
  </div>
  <nav class="bottom-tab-bar" id="bottomBar">
    <a class="tab-item active" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Home</a>
    <a class="tab-item" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a>
    <a class="tab-item" href="notifications.html"><i class="bi bi-bell"></i> Notifications</a>
    <a class="tab-item" href="#" id="logoutBtnMobile"><i class="bi bi-box-arrow-left"></i> Logout</a>
  </nav>
  <div id="toast-container-edu" class="toast-container-edu"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/notifications.js"></script>
  <script>
    (function () {
      const base = document.querySelector('script[src*="supabase-config"]').src.indexOf('edutrack') !== -1 ? '/edutrack' : '';
      requireAuth(['admin']).then(async function (profile) {
        if (!profile) return;
        document.getElementById('logoutBtn').onclick = document.getElementById('logoutBtnMobile').onclick = function () { EduTrackAuth.logout(); };
        document.getElementById('menuToggle').onclick = function () { document.getElementById('sidebar').classList.toggle('show'); document.getElementById('sidebarOverlay').classList.toggle('show'); };
        document.getElementById('sidebarOverlay').onclick = function () { document.getElementById('sidebar').classList.remove('show'); this.classList.remove('show'); };
        EduTrackNotifications.unreadCount(profile.id).then(function (c) {
          var b = document.getElementById('unreadBadge');
          if (c > 0) { b.textContent = c; b.style.display = 'inline'; }
        });
        var today = new Date().toISOString().slice(0, 10);
        var students = (await supabaseClient.from('users').select('id, department').eq('role', 'student')).data || [];
        var attendance = (await supabaseClient.from('attendance').select('student_id, status').eq('date', today)).data || [];
        var present = attendance.filter(function (a) { return a.status === 'present' || a.status === 'late'; }).length;
        var absent = attendance.filter(function (a) { return a.status === 'absent'; }).length;
        var notifCount = (await supabaseClient.from('notifications').select('*', { count: 'exact', head: true })).count || 0;
        var examCount = (await supabaseClient.from('exam_seats').select('*', { count: 'exact', head: true })).count || 0;
        var resultCount = (await supabaseClient.from('results').select('*', { count: 'exact', head: true })).count || 0;
        var last7 = []; for (var i = 6; i >= 0; i--) { var d = new Date(); d.setDate(d.getDate() - i); last7.push(d.toISOString().slice(0, 10)); }
        var trendData = []; for (var j = 0; j < last7.length; j++) {
          var dayAtt = (await supabaseClient.from('attendance').select('status').eq('date', last7[j])).data || [];
          var p = dayAtt.filter(function (a) { return a.status === 'present' || a.status === 'late'; }).length;
          trendData.push(p);
        }
        var deptMap = {}; attendance.forEach(function (a) { var s = students.find(function (x) { return x.id === a.student_id; }); if (s && (a.status === 'present' || a.status === 'late')) deptMap[s.department] = (deptMap[s.department] || 0) + 1; });
        var totalS = students.length;
        var avgPct = totalS ? Math.round((present / totalS) * 100) : 0;
        animateCounter('statTotalStudents', totalS);
        animateCounter('statPresent', present);
        animateCounter('statAbsent', absent);
        animateCounter('statNotifications', notifCount);
        animateCounter('statExams', examCount);
        animateCounter('statResults', resultCount);
        document.getElementById('statAvgAttendance').textContent = avgPct + '%';
        document.querySelectorAll('.stat-card').forEach(function (el) { el.style.opacity = '1'; });
        try {
          var w = (await supabaseClient.from('weather_logs').select('condition, is_unsafe').order('logged_at', { ascending: false }).limit(1)).data;
          document.getElementById('statWeather').textContent = w && w[0] ? (w[0].is_unsafe ? 'Unsafe' : 'Safe') : '—';
        } catch (e) { document.getElementById('statWeather').textContent = '—'; }
        new Chart(document.getElementById('chartTrend'), { type: 'line', data: { labels: last7.map(function (d) { return d.slice(5); }), datasets: [{ label: 'Present', data: trendData, borderColor: '#00C897', backgroundColor: 'rgba(0,200,151,0.1)', fill: true }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#A3AED0' } }, x: { grid: { display: false }, ticks: { color: '#A3AED0' } } } } });
        new Chart(document.getElementById('chartDept'), { type: 'doughnut', data: { labels: Object.keys(deptMap), datasets: [{ data: Object.values(deptMap), backgroundColor: ['#00E5FF', '#2196F3', '#00C897', '#FFB300', '#FF4560'] }] }, options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#A3AED0' } } } });
        var activities = (await supabaseClient.from('attendance').select('date, hour, created_at').order('created_at', { ascending: false }).limit(10)).data || [];
        document.getElementById('recentActivity').innerHTML = activities.length ? activities.map(function (a) { return '<div class="py-2 border-bottom border-secondary">Hour ' + a.hour + ' marked on ' + formatDate(a.date) + '</div>'; }).join('') : '<div class="text-muted">No recent activity</div>';
      });
    })();
  </script>
</body>
</html>
