<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seat Arrangement — EduTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="../assets/css/main.css" rel="stylesheet">
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">EduTrack</div>
    <nav class="sidebar-nav">
      <a class="nav-link" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Dashboard</a>
      <a class="nav-link" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a>
      <a class="nav-link active" href="seat-arrangement.html"><i class="bi bi-grid-3x3"></i> Seat Arrangement</a>
      <a class="nav-link" href="results.html"><i class="bi bi-journal-text"></i> Results</a>
      <a class="nav-link" href="weather.html"><i class="bi bi-cloud-sun"></i> Weather Monitor</a>
      <a class="nav-link" href="notifications.html"><i class="bi bi-bell"></i> Notifications</a>
      <a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</a>
    </nav>
  </aside>
  <div class="main-content">
    <h1 class="h3 mb-4">Exam Seat Allocation</h1>
    <div class="card card-glass p-3 mb-4">
      <h5 class="mb-3">Generate arrangement</h5>
      <div class="row g-3">
        <div class="col-md-4"><label class="form-label">Exam Name</label><input type="text" class="form-control form-control-edu" id="examName" placeholder="e.g. Mid Sem Nov 2025"></div>
        <div class="col-md-4"><label class="form-label">Exam Date</label><input type="date" class="form-control form-control-edu" id="examDate"></div>
        <div class="col-md-4"><label class="form-label">Departments (comma or multi-select)</label><select class="form-select form-select-edu" id="examDepts" multiple><option value="CSE">CSE</option><option value="ECE">ECE</option><option value="EEE">EEE</option><option value="MECH">MECH</option><option value="IT">IT</option></select></div>
        <div class="col-md-3"><label class="form-label">Number of Rooms</label><input type="number" class="form-control form-control-edu" id="numRooms" value="5" min="1"></div>
        <div class="col-md-3"><label class="form-label">Seats Per Room</label><input type="number" class="form-control form-control-edu" id="seatsPerRoom" value="30" min="1"></div>
        <div class="col-md-3"><label class="form-label">Arrangement</label><select class="form-select form-select-edu" id="arrangeMethod"><option value="Alphabetical">Alphabetical</option><option value="Roll Number">Roll Number</option><option value="Random">Random</option></select></div>
        <div class="col-md-3 d-flex align-items-end"><button type="button" class="btn btn-edu w-100" id="btnGenerate">Generate</button></div>
      </div>
    </div>
    <div class="card card-glass p-3 mb-3" id="previewCard" style="display:none;">
      <h5 class="mb-3">Preview — Room grid</h5>
      <div id="roomGrid" class="row g-2"></div>
    </div>
    <div class="card card-glass p-3 mb-3" id="tableCard" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-3"><h5 class="mb-0">Full assignment</h5><div><button type="button" class="btn btn-outline-edu btn-sm me-2" id="btnPrint">Print All</button><button type="button" class="btn btn-outline-edu btn-sm" id="btnExportSeats">Export CSV</button></div></div>
      <div class="table-responsive"><table class="table table-edu" id="seatsTable"><thead><tr><th>Room</th><th>Seat</th><th>Roll No</th><th>Name</th><th>Hall Ticket No</th></tr></thead><tbody id="seatsTableBody"></tbody></table></div>
    </div>
  </div>
  <nav class="bottom-tab-bar"><a class="tab-item" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Home</a><a class="tab-item" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a><a class="tab-item" href="notifications.html"><i class="bi bi-bell"></i> Notifications</a><a class="tab-item" href="#" id="logoutBtnMobile"><i class="bi bi-box-arrow-left"></i> Logout</a></nav>
  <div id="toast-container-edu" class="toast-container-edu"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/seat-arrange.js"></script>
  <script>
    (function () {
      requireAuth(['admin']).then(function (profile) {
        if (!profile) return;
        document.getElementById('logoutBtn').onclick = document.getElementById('logoutBtnMobile').onclick = function () { EduTrackAuth.logout(); };
        var lastAssignments = [];
        document.getElementById('btnGenerate').onclick = async function () {
          var examName = document.getElementById('examName').value.trim();
          var examDate = document.getElementById('examDate').value;
          var deptSelect = document.getElementById('examDepts');
          var depts = Array.from(deptSelect.selectedOptions).map(function (o) { return o.value; });
          if (!depts.length) depts = ['CSE'];
          var numRooms = parseInt(document.getElementById('numRooms').value, 10) || 5;
          var seatsPerRoom = parseInt(document.getElementById('seatsPerRoom').value, 10) || 30;
          var method = document.getElementById('arrangeMethod').value;
          if (!examName) { showToast('Enter exam name', 'warning'); return; }
          var students = await EduTrackSeat.loadStudentsByDepartments(depts);
          var sorted = EduTrackSeat.sortStudents(students, method);
          var assignments = EduTrackSeat.assignSeats(sorted, numRooms, seatsPerRoom);
          lastAssignments = assignments;
          try {
            await EduTrackSeat.upsertExamSeats(assignments.map(function (a) { return { student: a.student, room_number: a.room_number, seat_number: a.seat_number }; }), examName, examDate);
          } catch (e) { showToast(e.message || 'Upsert failed', 'error'); return; }
          var roomMap = {};
          assignments.forEach(function (a) {
            var r = a.room_number;
            if (!roomMap[r]) roomMap[r] = [];
            roomMap[r].push(a);
          });
          document.getElementById('roomGrid').innerHTML = Object.keys(roomMap).map(function (room) {
            return '<div class="col-md-4"><div class="card card-glass p-2"><strong>' + room + '</strong><div class="small">' + roomMap[room].map(function (x) { return x.seat_number + ': ' + (x.student.roll_number || x.student.name); }).join(', ') + '</div></div></div>';
          }).join('');
          document.getElementById('seatsTableBody').innerHTML = assignments.map(function (a) {
            var ht = EduTrackSeat.hallTicketNo(examDate, a.student.roll_number);
            return '<tr><td>' + a.room_number + '</td><td>' + a.seat_number + '</td><td>' + (a.student.roll_number || '') + '</td><td>' + (a.student.name || '') + '</td><td>' + ht + '</td></tr>';
          }).join('');
          document.getElementById('previewCard').style.display = 'block';
          document.getElementById('tableCard').style.display = 'block';
          showToast('Seats generated and saved.', 'success');
        });
        document.getElementById('btnPrint').onclick = function () { window.print(); };
        document.getElementById('btnExportSeats').onclick = function () { exportTableToCSV('seatsTable', 'exam-seats'); };
      });
    })();
  </script>
</body>
</html>
