<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Results — EduTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="../assets/css/main.css" rel="stylesheet">
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">EduTrack</div>
    <nav class="sidebar-nav">
      <a class="nav-link" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Dashboard</a>
      <a class="nav-link" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a>
      <a class="nav-link" href="seat-arrangement.html"><i class="bi bi-grid-3x3"></i> Seat Arrangement</a>
      <a class="nav-link active" href="results.html"><i class="bi bi-journal-text"></i> Results</a>
      <a class="nav-link" href="weather.html"><i class="bi bi-cloud-sun"></i> Weather Monitor</a>
      <a class="nav-link" href="notifications.html"><i class="bi bi-bell"></i> Notifications</a>
      <a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</a>
    </nav>
  </aside>
  <div class="main-content">
    <h1 class="h3 mb-4">Results Management</h1>
    <div class="card card-glass p-3 mb-4">
      <h5 class="mb-3">Add Result</h5>
      <div class="row g-3">
        <div class="col-md-3"><label class="form-label">Roll Number (search)</label><input type="text" class="form-control form-control-edu" id="rollSearch" placeholder="Type to search"><ul class="list-group list-group-flush position-absolute w-100 z-1" id="rollDropdown" style="display:none; max-height: 200px; overflow-y: auto;"></ul></div>
        <div class="col-md-3"><label class="form-label">Exam Type</label><select class="form-select form-select-edu" id="examType"><option value="internal">Internal</option><option value="external">External</option></select></div>
        <div class="col-md-2"><label class="form-label">Subject</label><input type="text" class="form-control form-control-edu" id="resSubject" placeholder="Subject"></div>
        <div class="col-md-2"><label class="form-label">Subject Code</label><input type="text" class="form-control form-control-edu" id="resCode" placeholder="e.g. CS101"></div>
        <div class="col-md-1"><label class="form-label">Marks</label><input type="number" class="form-control form-control-edu" id="resMarks" min="0" step="0.01"></div>
        <div class="col-md-1"><label class="form-label">Max</label><input type="number" class="form-control form-control-edu" id="resMax" value="100" min="1"></div>
        <div class="col-md-2"><label class="form-label">Semester</label><input type="number" class="form-control form-control-edu" id="resSem" min="1" max="8" placeholder="1-8"></div>
        <div class="col-md-2"><label class="form-label">Academic Year</label><input type="text" class="form-control form-control-edu" id="resYear" placeholder="e.g. 2024-25"></div>
        <div class="col-md-2 d-flex align-items-end"><button type="button" class="btn btn-edu w-100" id="btnAddResult">Add</button></div>
      </div>
      <input type="hidden" id="selectedStudentId">
      <div class="mt-3"><label class="form-label">Bulk CSV import (columns: roll_number, exam_type, subject, subject_code, marks_obtained, max_marks, semester, academic_year)</label><input type="file" class="form-control form-control-edu" id="csvFile" accept=".csv"></div>
    </div>
    <div class="card card-glass p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-3"><h5 class="mb-0">Results table</h5><button type="button" class="btn btn-edu btn-sm" id="btnPublishNotify">Publish & Notify Students</button></div>
      <div class="table-responsive"><table class="table table-edu" id="resultsTable"><thead><tr><th><input type="checkbox" id="selectAllResults"></th><th>Roll / Name</th><th>Exam</th><th>Subject</th><th>Code</th><th>Marks</th><th>Grade</th><th>Sem</th><th>Actions</th></tr></thead><tbody id="resultsTableBody"></tbody></table></div>
    </div>
  </div>
  <nav class="bottom-tab-bar"><a class="tab-item" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Home</a><a class="tab-item" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a><a class="tab-item" href="notifications.html"><i class="bi bi-bell"></i> Notifications</a><a class="tab-item" href="#" id="logoutBtnMobile"><i class="bi bi-box-arrow-left"></i> Logout</a></nav>
  <div id="toast-container-edu" class="toast-container-edu"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/results.js"></script>
  <script>
    (function () {
      requireAuth(['admin']).then(async function (profile) {
        if (!profile) return;
        document.getElementById('logoutBtn').onclick = document.getElementById('logoutBtnMobile').onclick = function () { EduTrackAuth.logout(); };
        var resultsList = [];
        var searchDebounced = debounce(async function () {
          var q = document.getElementById('rollSearch').value.trim();
          if (q.length < 2) { document.getElementById('rollDropdown').style.display = 'none'; return; }
          var list = await EduTrackResults.searchRollNumbers(q);
          var ul = document.getElementById('rollDropdown');
          ul.innerHTML = list.map(function (u) { return '<li class="list-group-item list-group-item-dark list-group-item-action" data-id="' + u.id + '" data-roll="' + (u.roll_number || '') + '">' + (u.roll_number || '') + ' — ' + (u.name || '') + '</li>'; }).join('');
          ul.style.display = list.length ? 'block' : 'none';
          ul.querySelectorAll('li').forEach(function (li) {
            li.onclick = function () {
              document.getElementById('selectedStudentId').value = li.getAttribute('data-id');
              document.getElementById('rollSearch').value = li.getAttribute('data-roll');
              ul.style.display = 'none';
            };
          });
        }, 300);
        document.getElementById('rollSearch').oninput = searchDebounced;
        document.getElementById('btnAddResult').onclick = async function () {
          var sid = document.getElementById('selectedStudentId').value;
          if (!sid) { showToast('Select a student (roll number)', 'warning'); return; }
          var subject = document.getElementById('resSubject').value.trim();
          if (!subject) { showToast('Enter subject', 'warning'); return; }
          var marks = document.getElementById('resMarks').value, max = document.getElementById('resMax').value || 100;
          try {
            await EduTrackResults.addResult(sid, document.getElementById('examType').value, subject, document.getElementById('resCode').value.trim(), marks, max, document.getElementById('resSem').value, document.getElementById('resYear').value.trim());
            showToast('Result added.', 'success');
            loadResults();
            document.getElementById('resSubject').value = ''; document.getElementById('resMarks').value = ''; document.getElementById('resCode').value = '';
          } catch (e) { showToast(e.message || 'Failed', 'error'); }
        };
        document.getElementById('csvFile').onchange = async function (e) {
          var file = e.target.files[0];
          if (!file) return;
          var text = await file.text();
          var rows = EduTrackResults.parseCSV(text);
          var rollToId = {};
          var ids = [...new Set(rows.map(function (r) { return (r.roll_number || r.roll || '').toString().trim(); }))];
          var users = (await supabaseClient.from('users').select('id, roll_number').eq('role', 'student').in('roll_number', ids)).data || [];
          users.forEach(function (u) { rollToId[u.roll_number] = u.id; });
          var mapFields = {
            studentId: function (row) { return rollToId[(row.roll_number || row.roll || '').toString().trim()]; },
            examType: function (row) { return row.exam_type || 'internal'; },
            subject: function (row) { return row.subject || ''; },
            subjectCode: function (row) { return row.subject_code || null; },
            marksObtained: function (row) { return row.marks_obtained || row.marks; },
            maxMarks: function (row) { return row.max_marks || row.max || 100; },
            semester: function (row) { return row.semester || null; },
            academicYear: function (row) { return row.academic_year || null; }
          };
          try {
            var n = await EduTrackResults.bulkInsert(rows, mapFields);
            showToast('Imported ' + n + ' results.', 'success');
            loadResults();
          } catch (err) { showToast(err.message || 'Import failed', 'error'); }
          e.target.value = '';
        };
        function renderResults(data) {
          resultsList = data || [];
          var tbody = document.getElementById('resultsTableBody');
          tbody.innerHTML = resultsList.map(function (r) {
            var u = r.users || {};
            return '<tr><td><input type="checkbox" class="result-cb" data-id="' + r.id + '"></td><td>' + (u.roll_number || '') + ' / ' + (u.name || '') + '</td><td>' + (r.exam_type || '') + '</td><td>' + (r.subject || '') + '</td><td>' + (r.subject_code || '') + '</td><td>' + r.marks_obtained + '/' + r.max_marks + '</td><td>' + (r.grade || '') + '</td><td>' + (r.semester || '') + '</td><td><button type="button" class="btn btn-outline-edu btn-sm me-1 edit-result" data-id="' + r.id + '">Edit</button><button type="button" class="btn btn-outline-danger btn-sm delete-result" data-id="' + r.id + '">Delete</button></td></tr>';
          }).join('');
          tbody.querySelectorAll('.delete-result').forEach(function (btn) {
            btn.onclick = async function () {
              if (!confirm('Delete this result?')) return;
              try {
                await EduTrackResults.deleteResult(btn.getAttribute('data-id'));
                showToast('Deleted.', 'success');
                loadResults();
              } catch (e) { showToast(e.message, 'error'); }
            };
          });
        }
        function loadResults() {
          EduTrackResults.loadResults().then(renderResults).catch(function (e) { showToast(e.message, 'error'); });
        }
        document.getElementById('selectAllResults').onchange = function () {
          document.querySelectorAll('.result-cb').forEach(function (cb) { cb.checked = document.getElementById('selectAllResults').checked; });
        };
        document.getElementById('btnPublishNotify').onclick = async function () {
          var ids = Array.from(document.querySelectorAll('.result-cb:checked')).map(function (c) { return c.getAttribute('data-id'); });
          if (!ids.length) { showToast('Select at least one result', 'warning'); return; }
          try {
            await EduTrackResults.publishAndNotify(ids);
            showToast('Notifications sent to students.', 'success');
          } catch (e) { showToast(e.message, 'error'); }
        };
        loadResults();
      });
    })();
  </script>
</body>
</html>
