<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance — EduTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="../assets/css/main.css" rel="stylesheet">
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">EduTrack</div>
    <nav class="sidebar-nav">
      <a class="nav-link" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Dashboard</a>
      <a class="nav-link active" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a>
      <a class="nav-link" href="seat-arrangement.html"><i class="bi bi-grid-3x3"></i> Seat Arrangement</a>
      <a class="nav-link" href="results.html"><i class="bi bi-journal-text"></i> Results</a>
      <a class="nav-link" href="weather.html"><i class="bi bi-cloud-sun"></i> Weather Monitor</a>
      <a class="nav-link" href="notifications.html"><i class="bi bi-bell"></i> Notifications</a>
      <a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</a>
    </nav>
  </aside>
  <div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3 mb-0">Attendance Management</h1>
      <button type="button" class="btn btn-edu d-lg-none" id="menuToggle" aria-label="Menu"><i class="bi bi-list"></i></button>
    </div>
    <ul class="nav nav-tabs mb-4" id="attTabs">
      <li class="nav-item"><a class="nav-link active" href="#mark" data-bs-toggle="tab">Mark</a></li>
      <li class="nav-item"><a class="nav-link" href="#records" data-bs-toggle="tab">Records</a></li>
      <li class="nav-item"><a class="nav-link" href="#summary" data-bs-toggle="tab">Summary</a></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="mark">
        <div class="card card-glass p-3 mb-3">
          <div class="row g-3">
            <div class="col-md-2"><label class="form-label">Department</label><select class="form-select form-select-edu" id="markDept"><option value="">All</option></select></div>
            <div class="col-md-2"><label class="form-label">Year</label><select class="form-select form-select-edu" id="markYear"><option value="">All</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
            <div class="col-md-2"><label class="form-label">Section</label><select class="form-select form-select-edu" id="markSection"><option value="">All</option><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>
            <div class="col-md-2"><label class="form-label">Date</label><input type="date" class="form-control form-control-edu" id="markDate"></div>
            <div class="col-md-2"><label class="form-label">Hour (1-8)</label><select class="form-select form-select-edu" id="markHour"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
            <div class="col-md-2 d-flex align-items-end"><button type="button" class="btn btn-edu w-100" id="markLoad">Load Students</button></div>
          </div>
          <div class="mt-3"><label class="form-label">Subject (optional)</label><input type="text" class="form-control form-control-edu w-100" id="markSubject" placeholder="e.g. Mathematics"></div>
        </div>
        <div class="card card-glass p-3">
          <div class="d-flex justify-content-between align-items-center mb-3"><h5 class="mb-0">Students</h5><button type="button" class="btn btn-outline-edu btn-sm" id="markAllPresent">Mark All Present</button></div>
          <div class="table-responsive"><table class="table table-edu table-hover" id="markTable"><thead><tr><th>Roll No</th><th>Name</th><th>Dept / Year / Sec</th><th>Status</th></tr></thead><tbody id="markTableBody"></tbody></table></div>
          <button type="button" class="btn btn-edu mt-3" id="markSubmit">Submit</button>
        </div>
      </div>
      <div class="tab-pane fade" id="records">
        <div class="card card-glass p-3 mb-3">
          <div class="row g-3">
            <div class="col-md-3"><label class="form-label">From</label><input type="date" class="form-control form-control-edu" id="recFrom"></div>
            <div class="col-md-3"><label class="form-label">To</label><input type="date" class="form-control form-control-edu" id="recTo"></div>
            <div class="col-md-3"><label class="form-label">Department</label><select class="form-select form-select-edu" id="recDept"><option value="">All</option></select></div>
            <div class="col-md-3 d-flex align-items-end"><button type="button" class="btn btn-edu w-100" id="recLoad">Load</button></div>
          </div>
        </div>
        <div class="card card-glass p-3"><button type="button" class="btn btn-outline-edu btn-sm mb-3" id="recExport">Export CSV</button><div class="table-responsive"><table class="table table-edu" id="recordsTable"><thead><tr><th>Date</th><th>Hour</th><th>Roll No</th><th>Name</th><th>Dept</th><th>Status</th></tr></thead><tbody id="recordsTableBody"></tbody></table></div><nav id="recPagination"></nav></div>
      </div>
      <div class="tab-pane fade" id="summary">
        <div class="card card-glass p-3"><p class="text-muted small">Student-wise attendance % (last ~90 days). Red if below 75%.</p><div class="table-responsive"><table class="table table-edu" id="summaryTable"><thead><tr><th>Roll No</th><th>Name</th><th>Department</th><th>Year</th><th>Section</th><th>Present</th><th>Total</th><th>%</th></tr></thead><tbody id="summaryTableBody"></tbody></table></div></div>
      </div>
    </div>
  </div>
  <nav class="bottom-tab-bar"><a class="tab-item" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Home</a><a class="tab-item active" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a><a class="tab-item" href="notifications.html"><i class="bi bi-bell"></i> Notifications</a><a class="tab-item" href="#" id="logoutBtnMobile"><i class="bi bi-box-arrow-left"></i> Logout</a></nav>
  <div id="toast-container-edu" class="toast-container-edu"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/attendance.js"></script>
  <script>
    (function () {
      requireAuth(['admin']).then(async function (profile) {
        if (!profile) return;
        document.getElementById('logoutBtn').onclick = document.getElementById('logoutBtnMobile').onclick = function () { EduTrackAuth.logout(); };
        document.getElementById('sidebarOverlay').onclick = function () { document.getElementById('sidebar').classList.remove('show'); this.classList.remove('show'); };
        var menuToggle = document.getElementById('menuToggle');
        if (menuToggle) menuToggle.onclick = function () { document.getElementById('sidebar').classList.toggle('show'); document.getElementById('sidebarOverlay').classList.toggle('show'); };
        var depts = await EduTrackAttendance.loadDepartments();
        depts.forEach(function (d) {
          var o1 = document.createElement('option'); o1.value = d; o1.textContent = d; document.getElementById('markDept').appendChild(o1);
          var o2 = document.createElement('option'); o2.value = d; o2.textContent = d; document.getElementById('recDept').appendChild(o2);
        });
        var today = new Date().toISOString().slice(0, 10);
        document.getElementById('markDate').value = today;
        var recPage = 1, recPageSize = 20, recTotal = 0;
        var markStudents = [];
        document.getElementById('markLoad').onclick = async function () {
          var dept = document.getElementById('markDept').value, year = document.getElementById('markYear').value, sec = document.getElementById('markSection').value, date = document.getElementById('markDate').value, hour = document.getElementById('markHour').value;
          if (!date || !hour) { showToast('Select date and hour', 'warning'); return; }
          markStudents = await EduTrackAttendance.loadStudents(dept, year, sec);
          var existing = await EduTrackAttendance.getExistingForHour(date, hour);
          var tbody = document.getElementById('markTableBody');
          tbody.innerHTML = '';
          markStudents.forEach(function (s) {
            var status = existing[s.id] || 'absent';
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + (s.roll_number || '—') + '</td><td>' + (s.name || '') + '</td><td>' + (s.department || '') + ' / ' + (s.year || '') + ' / ' + (s.section || '') + '</td><td><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="st_' + s.id + '" value="present" ' + (status === 'present' ? 'checked' : '') + '><label class="form-check-label">Present</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="st_' + s.id + '" value="absent" ' + (status === 'absent' ? 'checked' : '') + '><label class="form-check-label">Absent</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="st_' + s.id + '" value="late" ' + (status === 'late' ? 'checked' : '') + '><label class="form-check-label">Late</label></div></td>';
            tr.dataset.id = s.id;
            tbody.appendChild(tr);
          });
        };
        document.getElementById('markAllPresent').onclick = function () {
          markStudents.forEach(function (s) {
            var r = document.querySelector('input[name="st_' + s.id + '"][value="present"]');
            if (r) r.checked = true;
          });
        };
        document.getElementById('markSubmit').onclick = async function () {
          var date = document.getElementById('markDate').value, hour = document.getElementById('markHour').value, subject = document.getElementById('markSubject').value.trim();
          var rows = markStudents.map(function (s) {
            var r = document.querySelector('input[name="st_' + s.id + '"]:checked');
            return { id: s.id, status: r ? r.value : 'absent' };
          });
          if (!rows.length) { showToast('Load students first', 'warning'); return; }
          try {
            await EduTrackAttendance.saveMark(rows, date, hour, subject || null, profile.id);
            showToast('Attendance saved.', 'success');
            document.getElementById('markLoad').click();
          } catch (e) { showToast(e.message || 'Failed to save', 'error'); }
        };
        function loadRecords() {
          var from = document.getElementById('recFrom').value, to = document.getElementById('recTo').value, dept = document.getElementById('recDept').value;
          EduTrackAttendance.loadRecords(from, to, dept || null, recPage, recPageSize).then(function (r) {
            recTotal = r.count;
            var tbody = document.getElementById('recordsTableBody');
            tbody.innerHTML = '';
            (r.data || []).forEach(function (row) {
              var u = row.users || {};
              var tr = document.createElement('tr');
              tr.classList.add('row-' + row.status);
              tr.innerHTML = '<td>' + formatDate(row.date) + '</td><td>' + row.hour + '</td><td>' + (u.roll_number || '') + '</td><td>' + (u.name || '') + '</td><td>' + (u.department || '') + '</td><td><span class="badge-status badge-' + row.status + '">' + row.status + '</span></td>';
              tbody.appendChild(tr);
            });
            var totalPages = Math.ceil(recTotal / recPageSize) || 1;
            var nav = document.getElementById('recPagination');
            nav.innerHTML = '<ul class="pagination pagination-sm">' + (recPage > 1 ? '<li class="page-item"><a class="page-link" href="#" data-page="' + (recPage - 1) + '">Prev</a></li>' : '') + '<li class="page-item disabled"><span class="page-link">' + recPage + ' / ' + totalPages + '</span></li>' + (recPage < totalPages ? '<li class="page-item"><a class="page-link" href="#" data-page="' + (recPage + 1) + '">Next</a></li>' : '') + '</ul>';
            nav.querySelectorAll('a[data-page]').forEach(function (a) { a.onclick = function (e) { e.preventDefault(); recPage = parseInt(a.getAttribute('data-page'), 10); loadRecords(); }; });
          }).catch(function (e) { showToast(e.message || 'Failed to load', 'error'); });
        }
        document.getElementById('recLoad').onclick = function () { recPage = 1; loadRecords(); };
        document.getElementById('recExport').onclick = function () { exportTableToCSV('recordsTable', 'attendance-records'); };
        document.querySelector('#summary').addEventListener('shown.bs.tab', async function () {
          var list = await EduTrackAttendance.loadSummary();
          var tbody = document.getElementById('summaryTableBody');
          tbody.innerHTML = '';
          list.forEach(function (s) {
            var tr = document.createElement('tr');
            if (s.percentage < 75 && s.total > 0) tr.classList.add('table-danger');
            tr.innerHTML = '<td>' + (s.roll_number || '') + '</td><td>' + (s.name || '') + '</td><td>' + (s.department || '') + '</td><td>' + (s.year || '') + '</td><td>' + (s.section || '') + '</td><td>' + s.present + '</td><td>' + s.total + '</td><td>' + s.percentage + '%</td>';
            tbody.appendChild(tr);
          });
        });
      });
    })();
  </script>
</body>
</html>
