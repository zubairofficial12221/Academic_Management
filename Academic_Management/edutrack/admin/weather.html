<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather Monitor â€” EduTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="../assets/css/main.css" rel="stylesheet">
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">EduTrack</div>
    <nav class="sidebar-nav">
      <a class="nav-link" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Dashboard</a>
      <a class="nav-link" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a>
      <a class="nav-link" href="seat-arrangement.html"><i class="bi bi-grid-3x3"></i> Seat Arrangement</a>
      <a class="nav-link" href="results.html"><i class="bi bi-journal-text"></i> Results</a>
      <a class="nav-link active" href="weather.html"><i class="bi bi-cloud-sun"></i> Weather Monitor</a>
      <a class="nav-link" href="notifications.html"><i class="bi bi-bell"></i> Notifications</a>
      <a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</a>
    </nav>
  </aside>
  <div class="main-content">
    <h1 class="h3 mb-4">Weather Monitor</h1>
    <div id="weatherAlertBanner" class="weather-alert-banner mb-3" style="display:none;">ðŸš¨ SEVERE WEATHER â€” HOLIDAY RECOMMENDED</div>
    <div class="card card-glass p-3 mb-4">
      <div class="row align-items-center">
        <div class="col-md-8"><input type="text" class="form-control form-control-edu" id="weatherCity" placeholder="City (default: college city)" value=""></div>
        <div class="col-md-4 mt-2 mt-md-0"><button type="button" class="btn btn-edu w-100" id="weatherSearch">Search</button></div>
      </div>
    </div>
    <div class="card card-glass p-4 mb-4" id="weatherCard">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="d-flex align-items-center gap-3 mb-3">
            <span class="display-4" id="weatherIcon">â€”</span>
            <div><h2 class="mb-0" id="weatherTemp">â€”</h2><div class="text-muted" id="weatherCondition">â€”</div></div>
          </div>
          <div class="mb-2">Humidity: <strong id="weatherHumidity">â€”</strong></div>
          <div class="mb-2">Wind speed: <strong id="weatherWind">â€”</strong> m/s</div>
          <div class="mb-2">Visibility: <strong id="weatherVisibility">â€”</strong></div>
        </div>
        <div class="col-md-6 text-md-end">
          <span class="badge-status badge-pulse" id="weatherSafetyBadge">â€”</span>
        </div>
      </div>
    </div>
    <p class="small text-muted">Auto-refresh every 10 minutes.</p>
    <div class="card card-glass p-3">
      <h5 class="mb-3">Weather history</h5>
      <div class="table-responsive"><table class="table table-edu" id="weatherHistoryTable"><thead><tr><th>Time</th><th>City</th><th>Condition</th><th>Temp (Â°C)</th><th>Wind (m/s)</th><th>Unsafe</th></tr></thead><tbody id="weatherHistoryBody"></tbody></table></div>
    </div>
  </div>
  <nav class="bottom-tab-bar"><a class="tab-item" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Home</a><a class="tab-item" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a><a class="tab-item" href="notifications.html"><i class="bi bi-bell"></i> Notifications</a><a class="tab-item" href="#" id="logoutBtnMobile"><i class="bi bi-box-arrow-left"></i> Logout</a></nav>
  <div id="toast-container-edu" class="toast-container-edu"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/weather.js"></script>
  <script>
    (function () {
      requireAuth(['admin']).then(async function (profile) {
        if (!profile) return;
        document.getElementById('logoutBtn').onclick = document.getElementById('logoutBtnMobile').onclick = function () { EduTrackAuth.logout(); };
        var defaultCity = 'Chennai';
        document.getElementById('weatherCity').placeholder = 'City (default: ' + defaultCity + ')';
        var refreshTimer = null;
        function setSafetyBadge(unsafe) {
          var badge = document.getElementById('weatherSafetyBadge');
          if (unsafe) {
            badge.textContent = 'ðŸ”´ Unsafe';
            badge.className = 'badge-status badge-absent badge-pulse';
            document.getElementById('weatherAlertBanner').style.display = 'block';
          } else {
            badge.textContent = 'ðŸŸ¢ Safe';
            badge.className = 'badge-status badge-present';
            document.getElementById('weatherAlertBanner').style.display = 'none';
          }
        }
        function iconClass(main) {
          var m = (main || '').toLowerCase();
          if (m.indexOf('clear') !== -1) return 'bi bi-sun';
          if (m.indexOf('cloud') !== -1) return 'bi bi-cloud';
          if (m.indexOf('rain') !== -1) return 'bi bi-cloud-rain';
          if (m.indexOf('thunder') !== -1) return 'bi bi-cloud-lightning';
          return 'bi bi-cloud-sun';
        }
        async function fetchAndShow() {
          var city = document.getElementById('weatherCity').value.trim() || defaultCity;
          try {
            var data = await EduTrackWeather.fetchWeather(city);
            document.getElementById('weatherTemp').textContent = (data.main && data.main.temp != null) ? Math.round(data.main.temp) + ' Â°C' : 'â€”';
            document.getElementById('weatherCondition').textContent = (data.weather && data.weather[0]) ? data.weather[0].description : 'â€”';
            document.getElementById('weatherIcon').className = 'bi ' + iconClass(data.weather && data.weather[0] && data.weather[0].main) + ' display-4';
            document.getElementById('weatherHumidity').textContent = (data.main && data.main.humidity != null) ? data.main.humidity + '%' : 'â€”';
            document.getElementById('weatherWind').textContent = (data.wind && data.wind.speed != null) ? data.wind.speed : 'â€”';
            document.getElementById('weatherVisibility').textContent = (data.visibility != null) ? (data.visibility / 1000) + ' km' : 'â€”';
            var unsafe = EduTrackWeather.isUnsafe(data);
            setSafetyBadge(unsafe);
            await EduTrackWeather.logAndNotify(data, city, true);
            loadHistory();
          } catch (e) {
            showToast(e.message || 'Weather fetch failed', 'error');
          }
        }
        function loadHistory() {
          EduTrackWeather.loadHistory(50).then(function (rows) {
            document.getElementById('weatherHistoryBody').innerHTML = (rows || []).map(function (r) {
              return '<tr><td>' + formatDate(r.logged_at) + '</td><td>' + (r.city || '') + '</td><td>' + (r.condition || '') + '</td><td>' + (r.temperature != null ? r.temperature : 'â€”') + '</td><td>' + (r.wind_speed != null ? r.wind_speed : 'â€”') + '</td><td>' + (r.is_unsafe ? 'Yes' : 'No') + '</td></tr>';
            }).join('');
          }).catch(function () {});
        }
        document.getElementById('weatherSearch').onclick = fetchAndShow;
        fetchAndShow();
        refreshTimer = EduTrackWeather.startAutoRefresh(defaultCity, function (data) {
          var city = document.getElementById('weatherCity').value.trim() || defaultCity;
          document.getElementById('weatherTemp').textContent = (data.main && data.main.temp != null) ? Math.round(data.main.temp) + ' Â°C' : 'â€”';
          document.getElementById('weatherCondition').textContent = (data.weather && data.weather[0]) ? data.weather[0].description : 'â€”';
          setSafetyBadge(EduTrackWeather.isUnsafe(data));
          loadHistory();
        }, 600000);
        loadHistory();
      });
    })();
  </script>
</body>
</html>
