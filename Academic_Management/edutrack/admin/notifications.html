<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notifications â€” EduTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="../assets/css/main.css" rel="stylesheet">
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">EduTrack</div>
    <nav class="sidebar-nav">
      <a class="nav-link" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Dashboard</a>
      <a class="nav-link" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a>
      <a class="nav-link" href="seat-arrangement.html"><i class="bi bi-grid-3x3"></i> Seat Arrangement</a>
      <a class="nav-link" href="results.html"><i class="bi bi-journal-text"></i> Results</a>
      <a class="nav-link" href="weather.html"><i class="bi bi-cloud-sun"></i> Weather Monitor</a>
      <a class="nav-link active" href="notifications.html"><i class="bi bi-bell"></i> Notifications</a>
      <a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</a>
    </nav>
  </aside>
  <div class="main-content">
    <h1 class="h3 mb-4">Notification Center</h1>
    <div class="card card-glass p-3 mb-4">
      <h5 class="mb-3">Send manual notification</h5>
      <div class="row g-3">
        <div class="col-md-3"><label class="form-label">Recipient</label><select class="form-select form-select-edu" id="manualRecipient"><option value="all">All</option><option value="department">By Department</option><option value="individual">Individual student</option></select></div>
        <div class="col-md-3" id="wrapDept" style="display:none;"><label class="form-label">Department</label><select class="form-select form-select-edu" id="manualDept"><option value="CSE">CSE</option><option value="ECE">ECE</option><option value="EEE">EEE</option></select></div>
        <div class="col-md-3" id="wrapStudent" style="display:none;"><label class="form-label">Student (ID)</label><input type="text" class="form-control form-control-edu" id="manualStudentId" placeholder="User UUID"></div>
        <div class="col-md-6"><label class="form-label">Message</label><input type="text" class="form-control form-control-edu" id="manualMessage" placeholder="Message text"></div>
        <div class="col-md-3"><label class="form-label">Type</label><select class="form-select form-select-edu" id="manualType"><option value="general">General</option><option value="absence">Absence</option><option value="weather">Weather</option><option value="result">Result</option></select></div>
        <div class="col-md-3 d-flex align-items-end"><button type="button" class="btn btn-edu w-100" id="btnSendManual">Send</button></div>
      </div>
    </div>
    <div class="card card-glass p-3 mb-3">
      <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
        <label class="form-label mb-0">Filter:</label>
        <select class="form-select form-select-edu w-auto" id="filterType"><option value="all">All</option><option value="absence">Absence</option><option value="weather">Weather</option><option value="result">Result</option><option value="general">General</option></select>
        <button type="button" class="btn btn-outline-edu btn-sm" id="btnMarkAllRead">Mark all as read</button>
      </div>
      <div class="table-responsive"><table class="table table-edu" id="notifTable"><thead><tr><th>Recipient</th><th>Type</th><th>Message</th><th>Sent</th><th>Read</th><th>Action</th></tr></thead><tbody id="notifTableBody"></tbody></table></div>
      <nav id="notifPagination" class="mt-3"></nav>
    </div>
  </div>
  <nav class="bottom-tab-bar"><a class="tab-item" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Home</a><a class="tab-item" href="attendance.html"><i class="bi bi-clipboard-check"></i> Attendance</a><a class="tab-item active" href="notifications.html"><i class="bi bi-bell"></i> Notifications</a><a class="tab-item" href="#" id="logoutBtnMobile"><i class="bi bi-box-arrow-left"></i> Logout</a></nav>
  <div id="toast-container-edu" class="toast-container-edu"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/notifications.js"></script>
  <script>
    (function () {
      requireAuth(['admin']).then(async function (profile) {
        if (!profile) return;
        document.getElementById('logoutBtn').onclick = document.getElementById('logoutBtnMobile').onclick = function () { EduTrackAuth.logout(); };
        var notifPage = 1, notifPageSize = 20, notifTotal = 0;
        document.getElementById('manualRecipient').onchange = function () {
          var v = this.value;
          document.getElementById('wrapDept').style.display = v === 'department' ? 'block' : 'none';
          document.getElementById('wrapStudent').style.display = v === 'individual' ? 'block' : 'none';
        };
        document.getElementById('btnSendManual').onclick = async function () {
          var recipientType = document.getElementById('manualRecipient').value;
          var department = document.getElementById('manualDept').value;
          var studentId = document.getElementById('manualStudentId').value.trim();
          var message = document.getElementById('manualMessage').value.trim();
          var type = document.getElementById('manualType').value;
          if (!message) { showToast('Enter message', 'warning'); return; }
          if (recipientType === 'individual' && !studentId) { showToast('Enter student ID', 'warning'); return; }
          try {
            var n = await EduTrackNotifications.sendManual(recipientType, studentId || null, department || null, message, type);
            showToast('Sent to ' + n + ' recipient(s).', 'success');
            loadNotifs();
          } catch (e) { showToast(e.message || 'Send failed', 'error'); }
        };
        document.getElementById('btnMarkAllRead').onclick = function () {
          showToast('Mark all read applies to current user only. On admin view we show all; mark individually.', 'warning');
        };
        document.getElementById('filterType').onchange = function () { notifPage = 1; loadNotifs(); };
        function loadNotifs() {
          EduTrackNotifications.loadAllForAdmin(document.getElementById('filterType').value, notifPage, notifPageSize).then(function (r) {
            notifTotal = r.total;
            var tbody = document.getElementById('notifTableBody');
            tbody.innerHTML = (r.data || []).map(function (n) {
              var u = n.users || {};
              return '<tr class="' + (n.is_read ? '' : 'table-secondary') + '"><td>' + (u.name || u.email || n.recipient_id) + '</td><td>' + (n.type || '') + '</td><td>' + (n.message || '') + '</td><td>' + formatDate(n.sent_at) + '</td><td>' + (n.is_read ? 'Yes' : 'No') + '</td><td><button type="button" class="btn btn-outline-edu btn-sm mark-read-btn" data-id="' + n.id + '">Mark read</button></td></tr>';
            }).join('');
            tbody.querySelectorAll('.mark-read-btn').forEach(function (btn) {
              btn.onclick = async function () {
                try {
                  await supabaseClient.from('notifications').update({ is_read: true }).eq('id', btn.getAttribute('data-id'));
                  loadNotifs();
                } catch (e) {}
              };
            });
            var totalPages = Math.ceil(notifTotal / notifPageSize) || 1;
            document.getElementById('notifPagination').innerHTML = '<ul class="pagination pagination-sm">' + (notifPage > 1 ? '<li class="page-item"><a class="page-link" href="#" data-page="' + (notifPage - 1) + '">Prev</a></li>' : '') + '<li class="page-item disabled"><span class="page-link">' + notifPage + ' / ' + totalPages + '</span></li>' + (notifPage < totalPages ? '<li class="page-item"><a class="page-link" href="#" data-page="' + (notifPage + 1) + '">Next</a></li>' : '') + '</ul>';
            document.getElementById('notifPagination').querySelectorAll('a[data-page]').forEach(function (a) {
              a.onclick = function (e) { e.preventDefault(); notifPage = parseInt(a.getAttribute('data-page'), 10); loadNotifs(); };
            });
          }).catch(function (e) { showToast(e.message, 'error'); });
        }
        loadNotifs();
      });
    })();
  </script>
</body>
</html>
