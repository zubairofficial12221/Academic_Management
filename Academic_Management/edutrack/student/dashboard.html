<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard — EduTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="../assets/css/main.css" rel="stylesheet">
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">EduTrack</div>
    <nav class="sidebar-nav">
      <a class="nav-link active" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Dashboard</a>
      <a class="nav-link" href="attendance-view.html"><i class="bi bi-calendar-check"></i> View Attendance</a>
      <a class="nav-link" href="hall-ticket.html"><i class="bi bi-upc-scan"></i> Hall Ticket</a>
      <a class="nav-link" href="results-view.html"><i class="bi bi-journal-text"></i> Results</a>
      <a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</a>
    </nav>
  </aside>
  <div class="main-content">
    <h1 class="h3 mb-4">Student Dashboard</h1>
    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card card-glass p-4">
          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center text-white" style="width:64px;height:64px;"><i class="bi bi-person fs-2"></i></div>
            <div>
              <h5 class="mb-0" id="profileName">—</h5>
              <div class="text-muted small" id="profileRoll">—</div>
              <div class="text-muted small" id="profileDept">—</div>
              <div class="text-muted small" id="profileYearSection">—</div>
              <div class="text-muted small" id="profileMentor">Mentor: —</div>
            </div>
          </div>
        </div>
        <div class="card card-glass p-3 mt-3">
          <h6 class="mb-3">Attendance summary</h6>
          <div class="d-flex align-items-center gap-3">
            <div class="position-relative" style="width:80px;height:80px;">
              <svg class="progress-circle" width="80" height="80" viewBox="0 0 80 80"><circle class="progress-circle-bg" cx="40" cy="40" r="36" stroke-width="8"></circle><circle class="progress-circle-fill" id="attendanceCircle" cx="40" cy="40" r="36" stroke-width="8" stroke-dasharray="226" stroke-dashoffset="226"></circle></svg>
              <span class="position-absolute top-50 start-50 translate-middle small fw-bold" id="attendancePct">0%</span>
            </div>
            <div><div>Present: <strong id="attPresent">0</strong></div><div>Absent: <strong id="attAbsent">0</strong></div></div>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="card card-glass p-3 mb-3">
          <h6 class="mb-3">Upcoming exam</h6>
          <div id="upcomingExam">No upcoming exam.</div>
        </div>
        <div class="card card-glass p-3 mb-3">
          <h6 class="mb-3">Latest result</h6>
          <div id="latestResult">No results yet.</div>
        </div>
        <div class="card card-glass p-3 mb-3">
          <h6 class="mb-3">Unread notifications</h6>
          <ul class="list-unstyled mb-0" id="unreadList">Loading…</ul>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <a href="attendance-view.html" class="btn btn-edu">View Attendance</a>
          <a href="hall-ticket.html" class="btn btn-outline-edu">Download Hall Ticket</a>
          <a href="results-view.html" class="btn btn-outline-edu">Check Results</a>
        </div>
      </div>
    </div>
  </div>
  <nav class="bottom-tab-bar" id="bottomBar">
    <a class="tab-item active" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Home</a>
    <a class="tab-item" href="attendance-view.html"><i class="bi bi-calendar-check"></i> Attendance</a>
    <a class="tab-item" href="hall-ticket.html"><i class="bi bi-upc-scan"></i> Hall Ticket</a>
    <a class="tab-item" href="results-view.html"><i class="bi bi-journal-text"></i> Results</a>
    <a class="tab-item" href="#" id="logoutBtnMobile"><i class="bi bi-box-arrow-left"></i> Logout</a>
  </nav>
  <div id="toast-container-edu" class="toast-container-edu"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script>
    (function () {
      requireAuth(['student']).then(async function (profile) {
        if (!profile) return;
        document.getElementById('logoutBtn').onclick = document.getElementById('logoutBtnMobile').onclick = function () { EduTrackAuth.logout(); };
        document.getElementById('profileName').textContent = profile.name || '—';
        document.getElementById('profileRoll').textContent = profile.roll_number || '—';
        document.getElementById('profileDept').textContent = (profile.department || '') + ' · Year ' + (profile.year || '—');
        document.getElementById('profileYearSection').textContent = 'Section ' + (profile.section || '—');
        if (profile.mentor_id) {
          var mentor = (await supabaseClient.from('users').select('name').eq('id', profile.mentor_id).single()).data;
          document.getElementById('profileMentor').textContent = 'Mentor: ' + (mentor ? mentor.name : '—');
        }
        var start = new Date();
        start.setDate(start.getDate() - 90);
        var startStr = start.toISOString().slice(0, 10);
        var today = new Date().toISOString().slice(0, 10);
        var att = (await supabaseClient.from('attendance').select('status').eq('student_id', profile.id).gte('date', startStr).lte('date', today)).data || [];
        var present = att.filter(function (a) { return a.status === 'present' || a.status === 'late'; }).length;
        var total = att.length;
        var pct = total ? Math.round((present / total) * 100) : 0;
        document.getElementById('attendancePct').textContent = pct + '%';
        document.getElementById('attPresent').textContent = present;
        document.getElementById('attAbsent').textContent = total - present;
        var circumference = 2 * Math.PI * 36;
        document.getElementById('attendanceCircle').style.strokeDashoffset = circumference - (pct / 100) * circumference;
        var exam = (await supabaseClient.from('exam_seats').select('*').eq('student_id', profile.id).gte('exam_date', today).order('exam_date', { ascending: true }).limit(1)).data;
        if (exam && exam[0]) {
          document.getElementById('upcomingExam').innerHTML = '<strong>' + exam[0].exam_name + '</strong> on ' + formatDate(exam[0].exam_date) + ' — Room: ' + (exam[0].room_number || '') + ', Seat: ' + (exam[0].seat_number || '');
        }
        var res = (await supabaseClient.from('results').select('subject, grade, marks_obtained, max_marks').eq('student_id', profile.id).order('created_at', { ascending: false }).limit(1)).data;
        if (res && res[0]) {
          document.getElementById('latestResult').innerHTML = res[0].subject + ' — ' + res[0].marks_obtained + '/' + res[0].max_marks + ' (' + (res[0].grade || '') + ')';
        }
        var notifs = (await supabaseClient.from('notifications').select('message, sent_at, type').eq('recipient_id', profile.id).eq('is_read', false).order('sent_at', { ascending: false }).limit(5)).data || [];
        document.getElementById('unreadList').innerHTML = notifs.length ? notifs.map(function (n) { return '<li class="py-2 border-bottom border-secondary small">' + (n.message || '') + ' <span class="text-muted">' + formatDate(n.sent_at) + '</span></li>'; }).join('') : '<li class="text-muted">No unread notifications.</li>';
      });
    })();
  </script>
</body>
</html>
