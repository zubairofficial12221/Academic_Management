<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Results — EduTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="../assets/css/main.css" rel="stylesheet">
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">EduTrack</div>
    <nav class="sidebar-nav">
      <a class="nav-link" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Dashboard</a>
      <a class="nav-link" href="attendance-view.html"><i class="bi bi-calendar-check"></i> View Attendance</a>
      <a class="nav-link" href="hall-ticket.html"><i class="bi bi-upc-scan"></i> Hall Ticket</a>
      <a class="nav-link active" href="results-view.html"><i class="bi bi-journal-text"></i> Results</a>
      <a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</a>
    </nav>
  </aside>
  <div class="main-content">
    <h1 class="h3 mb-4">My Results</h1>
    <div class="mb-3 no-print"><button type="button" class="btn btn-edu btn-print-hide" id="btnDownloadPdf">Download PDF</button></div>
    <ul class="nav nav-tabs mb-4" id="semTabs">
      <li class="nav-item"><a class="nav-link active" href="#" data-sem="1">Sem 1</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-sem="2">Sem 2</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-sem="3">Sem 3</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-sem="4">Sem 4</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-sem="5">Sem 5</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-sem="6">Sem 6</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-sem="7">Sem 7</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-sem="8">Sem 8</a></li>
    </ul>
    <div class="card card-glass p-3 mb-3">
      <div class="table-responsive"><table class="table table-edu" id="resultsTable"><thead><tr><th>Subject</th><th>Code</th><th>Marks</th><th>Max</th><th>Grade</th><th>Pass/Fail</th></tr></thead><tbody id="resultsTableBody"></tbody></table></div>
      <div class="mt-3"><strong>GPA (this semester):</strong> <span id="gpaValue">—</span></div>
    </div>
  </div>
  <nav class="bottom-tab-bar"><a class="tab-item" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Home</a><a class="tab-item" href="attendance-view.html"><i class="bi bi-calendar-check"></i> Attendance</a><a class="tab-item" href="hall-ticket.html"><i class="bi bi-upc-scan"></i> Hall Ticket</a><a class="tab-item active" href="results-view.html"><i class="bi bi-journal-text"></i> Results</a><a class="tab-item" href="#" id="logoutBtnMobile"><i class="bi bi-box-arrow-left"></i> Logout</a></nav>
  <div id="toast-container-edu" class="toast-container-edu"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script>
    (function () {
      var gradeToPoint = { O: 10, 'A+': 9, A: 8, 'B+': 7, B: 6, C: 5, F: 0 };
      requireAuth(['student']).then(async function (profile) {
        if (!profile) return;
        document.getElementById('logoutBtn').onclick = document.getElementById('logoutBtnMobile').onclick = function () { EduTrackAuth.logout(); };
        var allResults = (await supabaseClient.from('results').select('*').eq('student_id', profile.id).order('semester').order('subject')).data || [];
        function renderSem(sem) {
          var list = allResults.filter(function (r) { return r.semester === sem; });
          document.getElementById('resultsTableBody').innerHTML = list.map(function (r) {
            var pass = r.grade !== 'F' && r.grade !== null;
            return '<tr><td>' + (r.subject || '') + '</td><td>' + (r.subject_code || '') + '</td><td>' + r.marks_obtained + '</td><td>' + r.max_marks + '</td><td>' + (r.grade || '') + '</td><td><span class="badge-status ' + (pass ? 'badge-present' : 'badge-absent') + '">' + (pass ? 'Pass' : 'Fail') + '</span></td></tr>';
          }).join('');
          var points = 0, count = 0;
          list.forEach(function (r) {
            var pt = gradeToPoint[r.grade];
            if (pt != null) { points += pt; count++; }
          });
          var gpa = count ? (points / count).toFixed(2) : '—';
          document.getElementById('gpaValue').textContent = gpa;
        }
        var currentSem = 1;
        document.querySelectorAll('#semTabs [data-sem]').forEach(function (tab) {
          tab.onclick = function (e) { e.preventDefault(); currentSem = parseInt(tab.getAttribute('data-sem'), 10); document.querySelectorAll('#semTabs .nav-link').forEach(function (t) { t.classList.remove('active'); }); tab.classList.add('active'); renderSem(currentSem); };
        });
        renderSem(1);
        document.getElementById('btnDownloadPdf').onclick = function () {
          var doc = new jspdf.jsPDF();
          doc.setFontSize(16);
          doc.text('EduTrack — Results', 14, 20);
          doc.setFontSize(10);
          doc.text('Student: ' + (profile.name || '') + ' | Roll: ' + (profile.roll_number || ''), 14, 28);
          var y = 36;
          [1,2,3,4,5,6,7,8].forEach(function (sem) {
            var list = allResults.filter(function (r) { return r.semester === sem; });
            if (!list.length) return;
            doc.setFontSize(12);
            doc.text('Semester ' + sem, 14, y);
            y += 6;
            doc.setFontSize(9);
            list.forEach(function (r) {
              doc.text((r.subject || '') + ' — ' + (r.grade || '') + ' (' + r.marks_obtained + '/' + r.max_marks + ')', 14, y);
              y += 5;
            });
            y += 4;
          });
          doc.save('edutrack-results-' + (profile.roll_number || 'student') + '.pdf');
          showToast('PDF downloaded.', 'success');
        };
      });
    })();
  </script>
</body>
</html>
