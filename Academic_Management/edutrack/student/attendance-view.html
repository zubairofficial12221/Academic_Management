<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance — EduTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="../assets/css/main.css" rel="stylesheet">
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">EduTrack</div>
    <nav class="sidebar-nav">
      <a class="nav-link" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Dashboard</a>
      <a class="nav-link active" href="attendance-view.html"><i class="bi bi-calendar-check"></i> View Attendance</a>
      <a class="nav-link" href="hall-ticket.html"><i class="bi bi-upc-scan"></i> Hall Ticket</a>
      <a class="nav-link" href="results-view.html"><i class="bi bi-journal-text"></i> Results</a>
      <a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</a>
    </nav>
  </aside>
  <div class="main-content">
    <h1 class="h3 mb-4">My Attendance</h1>
    <div id="warningBanner" class="alert alert-danger d-none mb-3">Your overall attendance is below 75%. Please improve.</div>
    <div class="card card-glass p-3 mb-4">
      <h5 class="mb-3">Monthly calendar</h5>
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <select class="form-select form-select-edu w-auto" id="calMonth"></select>
        <select class="form-select form-select-edu w-auto" id="calYear"></select>
      </div>
      <div id="calendarGrid" class="row g-1"></div>
      <div class="mt-3 small text-muted"><span class="d-inline-block rounded me-2" style="width:12px;height:12px;background:#00C897;"></span> Present &nbsp; <span class="d-inline-block rounded me-2" style="width:12px;height:12px;background:#FF4560;"></span> Absent &nbsp; <span class="d-inline-block rounded me-2" style="width:12px;height:12px;background:#6c757d;"></span> No class</span></div>
    </div>
    <div class="card card-glass p-3 mb-3">
      <h5 class="mb-3">Hour-by-hour breakdown — <span id="selectedDateLabel">Select a date</span></h5>
      <div class="table-responsive"><table class="table table-edu" id="hourTable"><thead><tr><th>Hour</th><th>Subject</th><th>Status</th></tr></thead><tbody id="hourTableBody"></tbody></table></div>
    </div>
    <div class="card card-glass p-3">
      <h5 class="mb-3">Subject-wise attendance %</h5>
      <div class="table-responsive"><table class="table table-edu" id="subjectTable"><thead><tr><th>Subject</th><th>Present</th><th>Total</th><th>%</th></tr></thead><tbody id="subjectTableBody"></tbody></table></div>
    </div>
  </div>
  <nav class="bottom-tab-bar"><a class="tab-item" href="dashboard.html"><i class="bi bi-grid-1x2"></i> Home</a><a class="tab-item active" href="attendance-view.html"><i class="bi bi-calendar-check"></i> Attendance</a><a class="tab-item" href="hall-ticket.html"><i class="bi bi-upc-scan"></i> Hall Ticket</a><a class="tab-item" href="results-view.html"><i class="bi bi-journal-text"></i> Results</a><a class="tab-item" href="#" id="logoutBtnMobile"><i class="bi bi-box-arrow-left"></i> Logout</a></nav>
  <div id="toast-container-edu" class="toast-container-edu"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script>
    (function () {
      requireAuth(['student']).then(async function (profile) {
        if (!profile) return;
        document.getElementById('logoutBtn').onclick = document.getElementById('logoutBtnMobile').onclick = function () { EduTrackAuth.logout(); };
        var attendanceByDate = {};
        var subjectStats = {};
        var allAttendance = (await supabaseClient.from('attendance').select('date, hour, subject, status').eq('student_id', profile.id)).data || [];
        allAttendance.forEach(function (a) {
          attendanceByDate[a.date] = attendanceByDate[a.date] || [];
          attendanceByDate[a.date].push(a);
          var sub = a.subject || 'Other';
          subjectStats[sub] = subjectStats[sub] || { present: 0, total: 0 };
          subjectStats[sub].total++;
          if (a.status === 'present' || a.status === 'late') subjectStats[sub].present++;
        });
        var totalPresent = 0, totalAll = 0;
        Object.keys(subjectStats).forEach(function (s) { totalPresent += subjectStats[s].present; totalAll += subjectStats[s].total; });
        if (totalAll > 0 && (totalPresent / totalAll) * 100 < 75) document.getElementById('warningBanner').classList.remove('d-none');
        var now = new Date();
        var y = now.getFullYear();
        for (var i = y - 2; i <= y + 1; i++) {
          var opt = document.createElement('option'); opt.value = i; opt.textContent = i; if (i === y) opt.selected = true; document.getElementById('calYear').appendChild(opt);
        }
        for (var m = 1; m <= 12; m++) {
          var o = document.createElement('option'); o.value = m; o.textContent = new Date(2000, m - 1, 1).toLocaleString('default', { month: 'long' }); if (m === now.getMonth() + 1) o.selected = true; document.getElementById('calMonth').appendChild(o);
        }
        function renderCalendar() {
          var year = parseInt(document.getElementById('calYear').value, 10);
          var month = parseInt(document.getElementById('calMonth').value, 10);
          var first = new Date(year, month - 1, 1);
          var last = new Date(year, month, 0);
          var startPad = first.getDay();
          var days = last.getDate();
          var html = '';
          for (var d = 0; d < startPad; d++) html += '<div class="col p-2 border border-secondary rounded text-muted" style="min-height:44px;"> </div>';
          for (var day = 1; day <= days; day++) {
            var dateStr = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
            var dayAtt = attendanceByDate[dateStr] || [];
            var hasPresent = dayAtt.some(function (x) { return x.status === 'present' || x.status === 'late'; });
            var hasAbsent = dayAtt.some(function (x) { return x.status === 'absent'; });
            var bg = dayAtt.length === 0 ? 'bg-secondary' : (hasAbsent && !hasPresent ? 'bg-danger' : 'bg-success');
            bg = bg.replace('bg-', '');
            var bgCl = dayAtt.length === 0 ? '#6c757d' : (hasAbsent && !hasPresent ? '#FF4560' : '#00C897');
            html += '<div class="col p-2 border border-secondary rounded text-white text-center" style="min-height:44px; background:' + bgCl + '; cursor:pointer;" data-date="' + dateStr + '">' + day + '</div>';
          }
          document.getElementById('calendarGrid').innerHTML = html;
          document.getElementById('calendarGrid').querySelectorAll('[data-date]').forEach(function (el) {
            el.onclick = function () {
              var dateStr = el.getAttribute('data-date');
              document.getElementById('selectedDateLabel').textContent = dateStr;
              var list = attendanceByDate[dateStr] || [];
              var byHour = {};
              list.forEach(function (a) { byHour[a.hour] = a; });
              var rows = [];
              for (var h = 1; h <= 8; h++) {
                var a = byHour[h];
                rows.push('<tr><td>' + h + '</td><td>' + (a ? (a.subject || '—') : '—') + '</td><td>' + (a ? '<span class="badge-status badge-' + a.status + '">' + a.status + '</span>' : 'No class') + '</td></tr>');
              }
              document.getElementById('hourTableBody').innerHTML = rows.join('');
            };
          });
        }
        document.getElementById('calMonth').onchange = document.getElementById('calYear').onchange = renderCalendar;
        renderCalendar();
        document.getElementById('subjectTableBody').innerHTML = Object.keys(subjectStats).map(function (sub) {
          var st = subjectStats[sub];
          var pct = st.total ? Math.round((st.present / st.total) * 100) : 0;
          return '<tr><td>' + sub + '</td><td>' + st.present + '</td><td>' + st.total + '</td><td>' + pct + '%</td></tr>';
        }).join('');
      });
    })();
  </script>
</body>
</html>
